<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sool Primary School Management</title>
  <style>
    :root { --primary: #3b82f6; --success: #10b981; --danger: #ef4444; --warning: #f59e0b; --bg: #f3f4f6; }
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family: -apple-system, sans-serif; background: #667eea; min-height: 100vh; padding: 15px; }
    .container { max-width: 550px; margin: 0 auto; }
    .card { background: white; border-radius: 16px; padding: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); margin-bottom: 20px; }
    h1 { text-align: center; margin-bottom: 20px; color: #1e293b; }
    label { display: block; margin: 10px 0 5px; font-weight: 600; color: #4b5563; }
    input, select { width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 16px; margin-bottom: 10px; }
    .btn { width: 100%; padding: 14px; border: none; border-radius: 8px; font-size: 16px; font-weight: 700; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-success { background: var(--success); color: white; }
    .btn-danger { background: var(--danger); color: white; }
    .btn-warning { background: var(--warning); color: white; }
    .tabs { display: flex; gap: 5px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; }
    .tab-btn { padding: 10px 15px; border: none; border-radius: 6px; background: #e5e7eb; cursor: pointer; font-weight: 600; white-space: nowrap; }
    .tab-btn.active { background: var(--primary); color: white; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .message { padding: 12px; border-radius: 8px; margin: 10px 0; text-align: center; display: none; }
    .success { background: #d1fae5; color: #065f46; }
    .error { background: #fee2e2; color: #991b1b; }
    
    .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
    .stat-card { padding: 15px; border-radius: 12px; background: #f8fafc; border: 1px solid #e2e8f0; text-align: center; }
    .stat-val { font-size: 24px; font-weight: 800; color: var(--primary); }
    .stat-label { font-size: 12px; color: #64748b; text-transform: uppercase; }

    .student-table-container { overflow-x: auto; margin-top: 10px; border: 1px solid #e5e7eb; border-radius: 8px; max-height: 400px; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th { background: #f9fafb; padding: 10px; text-align: left; border-bottom: 2px solid #e5e7eb; position: sticky; top: 0; }
    td { padding: 10px; border-bottom: 1px solid #f3f4f6; }
    .badge { padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; text-transform: uppercase; }
    .badge-active { background: #d1fae5; color: #065f46; }
    .badge-inactive { background: #fef3c7; color: #92400e; }
    .badge-dropout { background: #fee2e2; color: #991b1b; }
    .badge-paid { background: #d1fae5; color: #065f46; }
    .badge-pending { background: #fee2e2; color: #991b1b; }
    
    .loading { opacity: 0.6; pointer-events: none; }
  </style>
</head>
<body>

  <div class="container" id="loginView">
    <div class="card">
      <h1>üè´ Sool School</h1>
      <form id="loginForm">
        <label>Username</label>
        <input type="text" id="user" placeholder="Username" required>
        <label>Password</label>
        <input type="password" id="pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
        <button type="submit" class="btn btn-primary" id="loginBtn">Login</button>
      </form>
      <div id="loginMsg" class="message"></div>
    </div>
  </div>

  <div class="container" id="appView" style="display:none">
    <div class="card">
      <div id="header" style="text-align:center; margin-bottom:15px">
        <h2 id="greet">Welcome</h2>
        <small id="roleDisplay" style="color:#666; text-transform:uppercase"></small>
      </div>

      <div class="tabs" id="nav">
        <button class="tab-btn active" onclick="showTab('att')">Attendance</button>
        <button class="tab-btn" onclick="showTab('stats')">Statistics</button>
        <button class="tab-btn" onclick="showTab('list')">Student List</button>
      </div>

      <div id="appMsg" class="message"></div>

      <!-- Attendance Tab -->
      <div id="attTab" class="tab-content active">
        <label>Date</label>
        <input type="date" id="attDate">
        <label>Class (Active Students Only)</label>
        <select id="attClass" onchange="filterClassList()">
          <option value="">-- Select --</option>
          <option value="1aad">Grade 1</option><option value="2aad">Grade 2</option>
          <option value="3aad">Grade 3</option><option value="4aad">Grade 4</option>
          <option value="5aad">Grade 5</option><option value="6aad">Grade 6</option>
          <option value="7aad">Grade 7</option><option value="8aad">Grade 8</option>
        </select>

        <div id="previewList" style="display:none; background:#f9fafb; padding:10px; border-radius:8px; margin-bottom:10px; max-height:150px; overflow-y:auto;"></div>
        <button id="batchBtn" class="btn btn-success" style="display:none; margin-bottom:15px" onclick="markAll()">Mark All Present</button>

        <div style="border-top: 1px dashed #ccc; margin: 20px 0; padding-top: 10px;">
          <label>Student Roll #</label>
          <input type="number" id="rollId" placeholder="e.g. 1001" oninput="lookupStudent()">
          <label>Name</label>
          <input type="text" id="rollName" readonly style="background:#eee">
          
          <label>Status</label>
          <div style="display:flex; gap:5px; margin-bottom:15px">
            <button class="tab-btn active" style="flex:1" onclick="setAttStatus(this, 'present')">Present</button>
            <button class="tab-btn" style="flex:1" onclick="setAttStatus(this, 'absent')">Absent</button>
          </div>
          <button class="btn btn-primary" onclick="saveOne()">Save Entry</button>
        </div>
      </div>

      <!-- Statistics Tab -->
      <div id="statsTab" class="tab-content">
        <h3>School Overview</h3>
        <div class="stats-grid">
          <div class="stat-card"><div class="stat-val" id="statTotal">0</div><div class="stat-label">Total Students</div></div>
          <div class="stat-card"><div class="stat-val" id="statActive">0</div><div class="stat-label">Active</div></div>
          <div class="stat-card"><div class="stat-val" id="statDropout" style="color:var(--danger)">0</div><div class="stat-label">Dropouts</div></div>
          <div class="stat-card"><div class="stat-val" id="statInactive" style="color:var(--warning)">0</div><div class="stat-label">Inactive</div></div>
        </div>
        <button class="btn btn-primary" onclick="refreshData()">üîÑ Refresh Stats</button>
      </div>

      <!-- Student List Tab -->
      <div id="listTab" class="tab-content">
        <h3>Student Records</h3>
        <label>Filter by Status</label>
        <select id="listFilter" onchange="renderStudentTable()">
          <option value="all">All Students</option>
          <option value="active">Active Only</option>
          <option value="inactive">Inactive Only</option>
          <option value="dropout">Dropouts Only</option>
        </select>
        
        <button class="btn btn-warning" onclick="exportToCSV()" style="margin-bottom:10px">üì• Export Filtered List (CSV)</button>

        <div class="student-table-container">
          <table id="studentTable">
            <thead>
              <tr><th>ID</th><th>Name</th><th>Class</th><th>Status</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- Registration Tab (Admin Only) -->
      <div id="regTab" class="tab-content">
        <h3>Register New Student</h3>
        <label>Student Full Name</label><input type="text" id="rName">
        <label>Mother's Name</label><input type="text" id="rMother">
        <label>Date of Birth</label><input type="date" id="rDob">
        <label>Grade/Class</label>
        <select id="rClass">
          <option value="1aad">Grade 1</option><option value="2aad">Grade 2</option>
          <option value="3aad">Grade 3</option><option value="4aad">Grade 4</option>
          <option value="5aad">Grade 5</option><option value="6aad">Grade 6</option>
          <option value="7aad">Grade 7</option><option value="8aad">Grade 8</option>
        </select>
        <label>Initial Status</label>
        <select id="rStatus">
          <option value="active">Active</option>
          <option value="inactive">Inactive</option>
          <option value="dropout">Dropout</option>
        </select>
        <button class="btn btn-primary" onclick="doRegister()">Add Student</button>
      </div>

      <!-- Fee Tab (Admin Only) -->
      <div id="feeTab" class="tab-content">
        <h3>Fee Management</h3>
        <div style="background: #f1f5f9; padding: 15px; border-radius: 12px; margin-bottom: 20px;">
          <h4>New Payment</h4>
          <label>Roll #</label><input type="number" id="fRoll" oninput="lookupFee()">
          <label>Name</label><input type="text" id="fName" readonly style="background:#eee">
          <label>Amount ($)</label><input type="number" id="fAmt">
          <button class="btn btn-success" onclick="doFee()">Process Payment</button>
        </div>

        <div style="border-top: 2px solid #e2e8f0; padding-top: 15px;">
          <h4>Payment Status Report</h4>
          <label>Show Only Unpaid</label>
          <select id="feeFilter" onchange="renderFeeReport()">
            <option value="unpaid">Unpaid Students</option>
            <option value="all">All Active Students</option>
          </select>
          <div class="student-table-container">
            <table id="feeReportTable">
              <thead>
                <tr><th>Roll #</th><th>Name</th><th>Status</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <button class="btn btn-danger" style="margin-top:20px; font-size:12px" onclick="location.reload()">Logout</button>
    </div>
  </div>

  <script>
    const API = 'REPLACE_WITH_YOUR_WEB_APP_URL';
    let user = null;
    let students = [];
    let fees = [];
    let currentAttStatus = 'present';

    function msg(text, type='success') {
      const el = user ? document.getElementById('appMsg') : document.getElementById('loginMsg');
      el.textContent = text;
      el.className = `message ${type}`;
      el.style.display = 'block';
      setTimeout(() => el.style.display = 'none', 4000);
    }

    async function call(action, data={}) {
      document.body.classList.add('loading');
      try {
        const r = await fetch(API, { method: 'POST', body: JSON.stringify({...data, action}) });
        const res = await r.json();
        document.body.classList.remove('loading');
        return res;
      } catch(e) {
        document.body.classList.remove('loading');
        msg("Connection Error", "error");
        return { error: true };
      }
    }

    document.getElementById('loginForm').onsubmit = async (e) => {
      e.preventDefault();
      const res = await call('login', { username: document.getElementById('user').value, password: document.getElementById('pass').value });
      if(res.success) {
        user = res.user;
        document.getElementById('loginView').style.display = 'none';
        document.getElementById('appView').style.display = 'block';
        document.getElementById('greet').textContent = `Hi, ${user.username}`;
        document.getElementById('roleDisplay').textContent = user.role;
        document.getElementById('attDate').valueAsDate = new Date();
        
        if(user.role === 'admin') {
          const nav = document.getElementById('nav');
          nav.innerHTML += `<button class="tab-btn" onclick="showTab('reg')">Register</button>`;
          nav.innerHTML += `<button class="tab-btn" onclick="showTab('fee')">Fees</button>`;
        }
        await refreshData();
      } else {
        msg("Invalid Login", "error");
      }
    };

    async function refreshData() {
      const sData = await call('getStudents');
      // Note: Assuming your backend can return fees if requested, or we simulate fee tracking
      // For this version, we will handle 'getFees' if your backend script supports it, 
      // otherwise we assume 'fees' is an empty array or fetched separately.
      if(Array.isArray(sData)) {
        students = sData;
        updateStats();
        renderStudentTable();
        // Trigger fee report if on admin
        if(user && user.role === 'admin') renderFeeReport();
      }
    }

    function updateStats() {
      document.getElementById('statTotal').textContent = students.length;
      document.getElementById('statActive').textContent = students.filter(s => s.Status === 'active').length;
      document.getElementById('statDropout').textContent = students.filter(s => s.Status === 'dropout').length;
      document.getElementById('statInactive').textContent = students.filter(s => s.Status === 'inactive').length;
    }

    function renderStudentTable() {
      const filter = document.getElementById('listFilter').value;
      const tbody = document.querySelector('#studentTable tbody');
      tbody.innerHTML = '';
      const filtered = students.filter(s => filter === 'all' || s.Status === filter);
      filtered.forEach(s => {
        tbody.innerHTML += `<tr><td>${s.ID}</td><td>${s.Name}</td><td>${s.Class}</td><td><span class="badge badge-${s.Status}">${s.Status}</span></td></tr>`;
      });
    }

    function renderFeeReport() {
      const filter = document.getElementById('feeFilter').value;
      const tbody = document.querySelector('#feeReportTable tbody');
      tbody.innerHTML = '';
      
      // Logic: A student has paid if their Roll Number exists in the "Fees" records
      // In a real app, you would fetch the 'Fees' sheet rows here.
      // For now, we compare against local 'fees' array which would be populated from backend.
      
      const activeStudents = students.filter(s => s.Status === 'active');
      
      activeStudents.forEach(s => {
        const hasPaid = fees.some(f => String(f.rollNumber) === String(s.ID));
        if(filter === 'unpaid' && hasPaid) return;
        
        tbody.innerHTML += `
          <tr>
            <td>${s.ID}</td>
            <td>${s.Name}</td>
            <td><span class="badge badge-${hasPaid ? 'paid' : 'pending'}">${hasPaid ? 'Paid' : 'Unpaid'}</span></td>
          </tr>
        `;
      });
    }

    window.exportToCSV = () => {
      const filter = document.getElementById('listFilter').value;
      const filtered = students.filter(s => filter === 'all' || s.Status === filter);
      let csv = "ID,Name,MotherName,Class,Status\n";
      filtered.forEach(s => { csv += `${s.ID},"${s.Name}","${s.MotherName || ''}",${s.Class},${s.Status}\n`; });
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `students_${filter}.csv`;
      a.click();
    };

    window.showTab = (t) => {
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      const target = document.getElementById(t+'Tab');
      if(target) target.classList.add('active');
      event.target.classList.add('active');
      if(t === 'fee') renderFeeReport();
    };

    window.filterClassList = () => {
      const cls = document.getElementById('attClass').value;
      const box = document.getElementById('previewList');
      const btn = document.getElementById('batchBtn');
      if(!cls) { box.style.display = 'none'; btn.style.display = 'none'; return; }
      const list = students.filter(s => s.Class === cls && s.Status === 'active');
      box.innerHTML = list.map(s => `<div style="padding:4px 0; border-bottom:1px solid #eee">#${s.ID} - ${s.Name}</div>`).join('') || "No active students";
      box.style.display = 'block';
      btn.style.display = list.length > 0 ? 'block' : 'none';
    };

    window.lookupStudent = () => {
      const r = document.getElementById('rollId').value;
      const s = students.find(x => String(x.ID) === r && x.Status === 'active');
      document.getElementById('rollName').value = s ? s.Name : "Not found (or Inactive)";
    };

    window.lookupFee = () => {
      const r = document.getElementById('fRoll').value;
      const s = students.find(x => String(x.ID) === r);
      document.getElementById('fName').value = s ? s.Name : "";
    };

    window.setAttStatus = (btn, s) => {
      btn.parentElement.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentAttStatus = s;
    };

    window.saveOne = async () => {
      const roll = document.getElementById('rollId').value;
      const name = document.getElementById('rollName').value;
      if(!roll || name.includes("Not found")) return msg("Valid Roll # required", "error");
      const res = await call('recordAttendance', {
        date: document.getElementById('attDate').value,
        class: document.getElementById('attClass').value || 'Manual',
        rollNumber: roll,
        studentName: name,
        status: currentAttStatus,
        session: 'morning',
        recordedBy: user.username
      });
      if(res.success) { msg("Entry Saved"); document.getElementById('rollId').value = ""; }
    };

    window.markAll = async () => {
      const res = await call('markAllPresent', {
        date: document.getElementById('attDate').value,
        class: document.getElementById('attClass').value,
        session: 'morning',
        recordedBy: user.username
      });
      if(res.success) msg(`${res.count} marked present`);
    };

    window.doRegister = async () => {
      const name = document.getElementById('rName').value;
      if(!name) return msg("Name required", "error");
      const res = await call('addStudent', {
        name, 
        motherName: document.getElementById('rMother').value,
        dob: document.getElementById('rDob').value,
        class: document.getElementById('rClass').value,
        status: document.getElementById('rStatus').value
      });
      if(res.success) { msg("Added! ID: "+res.id); refreshData(); }
    };

    window.doFee = async () => {
      const roll = document.getElementById('fRoll').value;
      const amt = document.getElementById('fAmt').value;
      const name = document.getElementById('fName').value;
      if(!roll || !amt || !name) return msg("Fill all fields", "error");
      const res = await call('processFee', {
        student: name,
        roll, amount: amt, recordedBy: user.username, class: 'N/A'
      });
      if(res.success) { 
        msg("Payment Logged"); 
        fees.push({ rollNumber: roll }); // Update local cache
        document.getElementById('fRoll').value = ""; 
        document.getElementById('fAmt').value = ""; 
        renderFeeReport();
      }
    };
  </script>
</body>
</html>
