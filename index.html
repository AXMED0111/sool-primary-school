<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sool Primary School Management</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px;color:#333}
    .container{max-width:500px;margin:0 auto}
    .card{background:white;border-radius:20px;padding:30px;box-shadow:0 20px 40px rgba(0,0,0,0.1);margin-bottom:20px}
    h1{text-align:center;color:#1e293b;font-size:28px;margin-bottom:10px;font-weight:700}
    h2,h3{margin:25px 0 15px 0;color:#1e293b;font-weight:600}
    label{display:block;margin:12px 0 6px;font-weight:600;color:#374151}
    input,select{width:100%;padding:15px;border:2px solid #e5e7eb;border-radius:12px;font-size:16px;background:#f9fafb;transition:all 0.3s}
    input:focus,select:focus{border-color:#3b82f6;outline:none;background:white;box-shadow:0 0 0 3px rgba(59,130,246,0.1)}
    .btn{width:100%;padding:16px;margin:10px 0;border:none;border-radius:12px;font-size:16px;font-weight:700;cursor:pointer;transition:all 0.2s}
    .btn-primary{background:linear-gradient(135deg,#3b82f6,#1d4ed8);color:white}
    .btn-success{background:linear-gradient(135deg,#10b981,#059669);color:white}
    .btn-danger{background:linear-gradient(135deg,#ef4444,#dc2626);color:white}
    .btn:active{transform:translateY(1px)}
    .tabs{display:flex;gap:10px;margin:25px 0;flex-wrap:wrap}
    .tab-btn{flex:1;padding:14px;border:none;border-radius:12px;background:#f1f5f9;color:#6b7280;font-weight:600;cursor:pointer;transition:all 0.3s;flex-basis:90px}
    .tab-btn.active{background:#3b82f6;color:white;transform:translateY(-2px)}
    .tab-content{display:none}
    .tab-content.active{display:block;animation:slideIn 0.3s ease}
    @keyframes slideIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    .message{padding:15px;border-radius:12px;text-align:center;margin:15px 0;font-weight:600}
    .success{background:#d1fae5;color:#065f46;border:2px solid #a7f3d0}
    .error{background:#fee2e2;color:#991b1b;border:2px solid #fca5a5}
    #loginContainer{display:block}
    #appContainer{display:none}
    .form-row{display:flex;gap:12px}
    .form-row input{flex:1}
    .status-buttons,.session-buttons{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}
    .status-btn,.session-btn{flex:1;padding:12px;border:2px solid #e5e7eb;border-radius:10px;font-weight:600;cursor:pointer;transition:all 0.2s;min-width:80px}
    .status-btn.active,.session-btn.active{border-color:#3b82f6;background:#3b82f6;color:white;transform:scale(0.98)}
    .status-present{background:#dcfce7;border-color:#22c55e;color:#166534}
    .status-absent{background:#fee2e2;border-color:#ef4444;color:#dc2626}
    .status-late{background:#fef3c7;border-color:#f59e0b;color:#d97706}
    .status-sick{background:#e0e7ff;border-color:#6366f1;color:#3730a3}
    .students-list{max-height:350px;overflow-y:auto;margin:20px 0}
    .student-row{display:flex;justify-content:space-between;align-items:center;padding:15px;background:#f8fafc;border-radius:12px;margin:8px 0;border-left:4px solid #3b82f6}
    .student-info{font-weight:600}
    
    /* Statistics Cards */
    .stats-container{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:15px;margin:20px 0}
    .stat-card{background:linear-gradient(135deg,#f3f4f6,#e5e7eb);border-radius:12px;padding:20px;text-align:center;box-shadow:0 4px 6px rgba(0,0,0,0.1);border-left:4px solid #3b82f6}
    .stat-card.active{background:linear-gradient(135deg,#dcfce7,#a7f3d0);border-left-color:#22c55e}
    .stat-card.inactive{background:linear-gradient(135deg,#fef3c7,#fde68a);border-left-color:#f59e0b}
    .stat-card.dropout{background:linear-gradient(135deg,#fee2e2,#fecaca);border-left-color:#ef4444}
   stat-number{font-size:32px;font-weight:800;margin:10px 0;color:#1e293b}
    .stat-label{font-size:14px;color:#6b7280;font-weight:600}
    
    /* Chart Container */
    .chart-container{background:#f8fafc;border-radius:12px;padding:20px;margin:20px 0;text-align:center}
    .chart-bar{height:24px;border-radius:12px;margin:8px 0;background:linear-gradient(90deg,#3b82f6,#60a5fa);position:relative;overflow:hidden}
    .chart-label{position:absolute;left:8px;color:white;font-weight:600;line-height:24px;text-shadow:0 0 2px rgba(0,0,0,0.5)}
    
    /* User Management Styles */
    .user-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:15px;margin:20px 0}
    .user-card{background:white;border-radius:12px;padding:15px;border:2px solid #e5e7eb;box-shadow:0 2px 4px rgba(0,0,0,0.05);transition:all 0.3s}
    .user-card:hover{transform:translateY(-2px);box-shadow:0 4px 8px rgba(0,0,0,0.1);border-color:#3b82f6}
    .user-role{display:inline-block;padding:4px 10px;border-radius:20px;font-size:12px;font-weight:600;margin-top:5px}
    .role-admin{background:#fee2e2;color:#dc2626}
    .role-teacher{background:#dbeafe;color:#1e40af}
    .user-actions{display:flex;gap:8px;margin-top:10px}
    .user-btn{flex:1;padding:8px;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;border:none;transition:all 0.2s}
    .btn-edit{background:#dbeafe;color:#1e40af}
    .btn-delete{background:#fee2e2;color:#dc2626}
    .btn-activate{background:#dcfce7;color:#166534}
    
    /* Loading indicator */
    .loading{display:inline-block;width:20px;height:20px;border:3px solid rgba(255,255,255,0.3);border-radius:50%;border-top-color:#3b82f6;animation:spin 1s linear infinite;margin:0 auto}
    @keyframes spin{to{transform:rotate(360deg)}}
    
    /* Login hint */
    .login-hint{background:#f0f9ff;padding:15px;border-radius:12px;margin-top:15px;font-size:14px;text-align:center;color:#1e40af}
    
    /* Responsive adjustments */
    @media (max-width: 480px) {
      .container{padding:10px}
      .card{padding:20px;border-radius:16px}
      .tabs{flex-direction:column}
      .tab-btn{width:100%}
      .form-row{flex-direction:column}
      .stats-container{grid-template-columns:repeat(2,1fr)}
      .user-grid{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <!-- LOGIN -->
  <div class="container" id="loginContainer">
    <div class="card">
      <h1>üè´ Sool Primary School</h1>
      <form id="loginForm">
        <label>üë§ Username</label>
        <input type="text" id="username" placeholder="Enter your username" required autocomplete="username">
        <label>üîë Password</label>
        <input type="password" id="password" placeholder="Enter password" required autocomplete="current-password">
        <button type="submit" class="btn btn-primary">Login ‚Üí</button>
        <div id="loginMessage" class="message" style="display:none"></div>
      </form>
    </div>
  </div>

  <!-- MAIN APP -->
  <div class="container" id="appContainer">
    <div class="card">
      <div style="text-align:center;padding:15px;background:linear-gradient(135deg,#3b82f6,#1d4ed8);color:white;border-radius:12px 12px 0 0;margin:-30px -30px 20px -30px">
        <h1>üìö School Dashboard</h1>
        <div id="userInfo" style="font-size:16px;margin-top:5px"></div>
      </div>

      <div class="tabs" id="tabs"></div>
      <div id="globalMessage" class="message" style="display:none"></div>

      <!-- ATTENDANCE TAB -->
      <div id="attendanceTab" class="tab-content active">
        <label>Date:</label>
        <div class="form-row">
          <input type="date" id="attDate">
          <button type="button" class="btn btn-success" onclick="setToday()" style="width:120px;padding:15px 10px">Today</button>
        </div>
        
        <label>Session:</label>
        <div class="session-buttons">
          <button class="session-btn active" data-session="morning">Morning</button>
          <button class="session-btn" data-session="afternoon">Afternoon</button>
        </div>
        
        <label>Class:</label>
        <select id="attClass" onchange="loadClassStudents()">
          <option value="">Select Class</option>
          <option value="1aad">Grade 1 - 1aad</option>
          <option value="2aad">Grade 2 - 2aad</option>
          <option value="3aad">Grade 3 - 3aad</option>
          <option value="4aad">Grade 4 - 4aad</option>
          <option value="5aad">Grade 5 - 5aad</option>
          <option value="6aad">Grade 6 - 6aad</option>
          <option value="7aad">Grade 7 - 7aad</option>
          <option value="8aad">Grade 8 - 8aad</option>
        </select>

        <div id="classStudentsList" class="students-list" style="display:none;margin-top:15px"></div>
        <button class="btn btn-success" onclick="markAllPresent()" style="margin:20px 0;display:none" id="markAllBtn">üìã Mark All Present</button>

        <h3 style="margin-top:25px">Single Entry:</h3>
        <label>Roll Number:</label>
        <input type="number" id="attRoll" placeholder="Enter roll number" min="1">
        <label>Student Name:</label>
        <input type="text" id="attName" placeholder="Will auto-fill" readonly>
        
        <label>Status:</label>
        <div class="status-buttons">
          <button class="status-btn present active" data-status="present">Present</button>
          <button class="status-btn absent" data-status="absent">Absent</button>
          <button class="status-btn late" data-status="late">Late</button>
          <button class="status-btn sick" data-status="sick">Sick</button>
        </div>
        <button class="btn btn-primary" onclick="saveAttendance()">üíæ Save Attendance</button>
        <button class="btn btn-danger" onclick="logout()" style="margin-top:10px">üö™ Logout</button>
      </div>

      <!-- STUDENT REGISTRATION (ADMIN ONLY) -->
      <div id="registerTab" class="tab-content">
        <h2>üìù Student Registration</h2>
        <label>Full Name:</label><input type="text" id="regName" required>
        <label>Mother's Name:</label><input type="text" id="regMother">
        <label>Date of Birth:</label><input type="date" id="regDob">
        <label>Place of Birth:</label><input type="text" id="regPob" placeholder="e.g. Garowe">
        <label>Contact Number:</label><input type="tel" id="regPhone" placeholder="+252 61...">
        <label>Class:</label>
        <select id="regClass" required>
          <option value="">Select Class</option>
          <option value="1aad">Grade 1 - 1aad</option>
          <option value="2aad">Grade 2 - 2aad</option>
          <option value="3aad">Grade 3 - 3aad</option>
          <option value="4aad">Grade 4 - 4aad</option>
          <option value="5aad">Grade 5 - 5aad</option>
          <option value="6aad">Grade 6 - 6aad</option>
          <option value="7aad">Grade 7 - 7aad</option>
          <option value="8aad">Grade 8 - 8aad</option>
        </select>
        <label>Status:</label>
        <select id="regStatus" required>
          <option value="active">Active</option>
          <option value="inactive">Inactive</option>
          <option value="dropout">Dropout</option>
        </select>
        <button class="btn btn-primary" onclick="registerStudent()">‚ûï Register Student</button>
        <button class="btn btn-danger" onclick="logout()" style="margin-top:10px">üö™ Logout</button>
      </div>

      <!-- STUDENT STATISTICS TAB -->
      <div id="statsTab" class="tab-content">
        <h2>üìä Student Statistics</h2>
        
        <div class="stats-container">
          <div class="stat-card active">
            <div class="stat-label">Active Students</div>
            <div class="stat-number" id="activeCount">-</div>
          </div>
          <div class="stat-card inactive">
            <div class="stat-label">Inactive Students</div>
            <div class="stat-number" id="inactiveCount">-</div>
          </div>
          <div class="stat-card dropout">
            <div class="stat-label">Dropout Students</div>
            <div class="stat-number" id="dropoutCount">-</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Total Students</div>
            <div class="stat-number" id="totalCount">-</div>
          </div>
        </div>
        
        <div class="chart-container">
          <h3 style="margin-bottom:15px;color:#1e293b">Student Status Distribution</h3>
          <div style="text-align:left;margin-top:15px">
            <div style="display:flex;justify-content:space-between;margin-bottom:5px">
              <span style="font-weight:600">Active</span>
              <span id="activePct">0%</span>
            </div>
            <div class="chart-bar" id="activeBar" style="width:0%"><span class="chart-label" id="activeBarLabel">0%</span></div>
            
            <div style="display:flex;justify-content:space-between;margin:8px 0 5px">
              <span style="font-weight:600">Inactive</span>
              <span id="inactivePct">0%</span>
            </div>
            <div class="chart-bar" id="inactiveBar" style="width:0%;background:linear-gradient(90deg,#f59e0b,#fbbf24)"><span class="chart-label" id="inactiveBarLabel">0%</span></div>
            
            <div style="display:flex;justify-content:space-between;margin:8px 0 5px">
              <span style="font-weight:600">Dropout</span>
              <span id="dropoutPct">0%</span>
            </div>
            <div class="chart-bar" id="dropoutBar" style="width:0%;background:linear-gradient(90deg,#ef4444,#f87171)"><span class="chart-label" id="dropoutBarLabel">0%</span></div>
          </div>
        </div>
        
        <div style="background:#f8fafc;padding:20px;border-radius:12px;margin:20px 0">
          <h3 style="margin-bottom:15px;color:#1e293b">üìä Detailed Breakdown</h3>
          <div style="display:flex;justify-content:space-between;margin:10px 0">
            <span style="font-weight:600">Active:</span>
            <span id="activeDetail">0 students</span>
          </div>
          <div style="display:flex;justify-content:space-between;margin:10px 0">
            <span style="font-weight:600">Inactive:</span>
            <span id="inactiveDetail">0 students</span>
          </div>
          <div style="display:flex;justify-content:space-between;margin:10px 0">
            <span style="font-weight:600">Dropout:</span>
            <span id="dropoutDetail">0 students</span>
          </div>
          <div style="display:flex;justify-content:space-between;margin:10px 0;border-top:2px solid #e5e7eb;padding-top:10px">
            <span style="font-weight:700">Total:</span>
            <span style="font-weight:700" id="totalDetail">0 students</span>
          </div>
        </div>
        
        <button class="btn btn-primary" onclick="refreshStats()">‚ü≥ Refresh Data</button>
        <button class="btn btn-danger" onclick="logout()" style="margin-top:10px">üö™ Logout</button>
      </div>

      <!-- USER MANAGEMENT TAB (ADMIN ONLY) -->
      <div id="usersTab" class="tab-content">
        <h2>üë• User Management</h2>
        
        <div style="background:#f0f9ff;padding:15px;border-radius:12px;margin-bottom:20px">
          <h3 style="margin-bottom:10px;color:#1e40af">‚ûï Add New User</h3>
          <label>Username:</label>
          <input type="text" id="newUsername" placeholder="Enter username" required>
          <label>Password:</label>
          <input type="password" id="newPassword" placeholder="Enter password" required>
          <label>Role:</label>
          <select id="newUserRole" required>
            <option value="teacher">Teacher</option>
            <option value="admin">Admin</option>
          </select>
          <button class="btn btn-success" onclick="addNewUser()" style="margin-top:10px">‚ûï Create User</button>
        </div>
        
        <h3 style="margin:25px 0 15px 0;color:#1e293b">üìã All Users</h3>
        <div id="usersLoading" class="loading" style="display:none;margin:20px auto"></div>
        <div class="user-grid" id="usersList"></div>
        
        <button class="btn btn-danger" onclick="logout()" style="margin-top:10px">üö™ Logout</button>
      </div>

      <!-- FEE MANAGEMENT (ADMIN ONLY) -->
      <div id="feeTab" class="tab-content">
        <h2>üí∞ Fee Management</h2>
        <label>Student Name:</label><input type="text" id="feeStudent">
        <label>Roll:</label><input type="text" id="feeRoll">
        <label>Class:</label>
        <select id="feeClass">
          <option value="">Select Class</option>
          <option value="1aad">Grade 1 - 1aad</option>
          <option value="2aad">Grade 2 - 2aad</option>
          <option value="3aad">Grade 3 - 3aad</option>
          <option value="4aad">Grade 4 - 4aad</option>
          <option value="5aad">Grade 5 - 5aad</option>
          <option value="6aad">Grade 6 - 6aad</option>
          <option value="7aad">Grade 7 - 7aad</option>
          <option value="8aad">Grade 8 - 8aad</option>
        </select>
        <label>Amount:</label>
        <input type="number" id="feeAmount" placeholder="Enter amount">
        <button class="btn btn-primary" onclick="processFee()">‚úÖ Process Payment</button>
        <button class="btn btn-danger" onclick="logout()" style="margin-top:10px">üö™ Logout</button>
      </div>
    </div>
  </div>

  <script>
    // ===== CORRECTED GOOGLE SHEETS URL (NO API KEY) =====
    const API_URL = 'https://script.google.com/macros/s/AKfycbyOniTH3MDhiWtqFAv3rTIk2X4HPkSBLB_40o9DH2GPIq36UNGtS1QATCcy2n2opw-5Mw/exec';
    
    // System state
    let currentUser = null;
    let allStudents = [];
    let allUsers = [];
    
    // Initialize today's date
    function setToday() {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('attDate').value = today;
      document.getElementById('attDate').max = today;
    }
    setToday();
    
    // Session button handlers
    document.querySelectorAll('.session-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.session-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
      });
    });
    
    // Status button handlers
    document.querySelectorAll('.status-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.status-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
      });
    });
    
    // ===== GOOGLE SHEETS INTEGRATION (NO API KEY) =====
    async function apiRequest(action, method = 'get', data = {}) {
      try {
        const url = new URL(API_URL);
        url.searchParams.append('action', action);
        
        const options = {
          method: method.toUpperCase(),
          headers: {'Content-Type': 'application/json'},
        };
        
        if (method.toLowerCase() === 'post') {
          options.body = JSON.stringify({action, ...data});
        }
        
        const response = await fetch(method === 'get' ? url : API_URL, options);
        
        // Handle CORS preflight
        if (response.status === 204) {
          return {success: true};
        }
        
        if (!response.ok) {
          if (response.status === 401) {
            throw new Error('Invalid credentials');
          }
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        
        if (result.error) {
          throw new Error(result.error);
        }
        
        return result;
      } catch (error) {
        console.error('API Error:', error);
        showMessage(`Error: ${error.message || 'Connection failed'}`, 'error');
        return null;
      }
    }
    
    // ===== LOGIN HANDLER (FIXED) =====
    document.getElementById('loginForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value.trim();
      const msg = document.getElementById('loginMessage');
      
      if (!username || !password) {
        showMessage('Please enter both username and password', 'error');
        return;
      }
      
      // Show loading state
      const submitBtn = this.querySelector('button[type="submit"]');
      const originalText = submitBtn.innerHTML;
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<div class="loading" style="width:24px;height:24px;margin:0 auto"></div>';
      
      try {
        const result = await apiRequest('login', 'post', {username, password});
        
        if (result && result.success && result.user) {
          currentUser = result.user;
          document.getElementById('userInfo').textContent = `${currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1)}: ${currentUser.username}`;
          document.getElementById('loginContainer').style.display = 'none';
          document.getElementById('appContainer').style.display = 'block';
          msg.style.display = 'none';
          
          // Initialize UI based on role
          initTabs();
          
          // Load critical data
          await Promise.all([
            loadStudentStatistics(),
            loadUsers()
          ]);
          
          showMessage(`Welcome, ${currentUser.username}!`, 'success');
        } else {
          // Enhanced error handling
          if (result && result.message) {
            showMessage(result.message, 'error');
          } else {
            showMessage('Invalid username or password. Please try again.', 'error');
          }
        }
      } catch (error) {
        console.error('Login error:', error);
        // More specific error messages
        if (error.message.includes('Invalid credentials')) {
          showMessage('Invalid username or password. Please try again.', 'error');
        } else if (error.message.includes('Connection failed')) {
          showMessage('Connection error. Please check your internet connection.', 'error');
        } else {
          showMessage('Login failed: ' + error.message, 'error');
        }
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
      }
    });
    
    // Initialize tabs based on user role
    function initTabs() {
      const tabsContainer = document.getElementById('tabs');
      tabsContainer.innerHTML = '';
      
      // Common tabs for all users
      addTab('attendanceTab', 'üìÖ Attendance', true);
      
      if (currentUser && currentUser.role === 'admin') {
        addTab('registerTab', 'üìù Register');
        addTab('statsTab', ' Statistics');
        addTab('usersTab', 'üë• Users');
        addTab('feeTab', 'üí∞ Fees');
      }
      
      // Set up tab click handlers
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const targetTab = btn.dataset.tab;
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
          btn.classList.add('active');
          document.getElementById(targetTab).classList.add('active');
          
          // Refresh data when switching to certain tabs
          if (targetTab === 'statsTab') loadStudentStatistics();
          if (targetTab === 'usersTab') loadUsers();
          if (targetTab === 'attendanceTab') {
            document.getElementById('classStudentsList').style.display = 'none';
            document.getElementById('markAllBtn').style.display = 'none';
          }
        });
      });
    }
    
    function addTab(tabId, label, isActive = false) {
      const tabsContainer = document.getElementById('tabs');
      const tabBtn = document.createElement('button');
      tabBtn.className = `tab-btn ${isActive ? 'active' : ''}`;
      tabBtn.textContent = label;
      tabBtn.dataset.tab = tabId;
      tabsContainer.appendChild(tabBtn);
      
      if (isActive) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
      }
    }
    
    // ===== STUDENT STATISTICS =====
    async function loadStudentStatistics() {
      showMessage('Loading statistics...', 'success');
      const data = await apiRequest('getStudents');
      
      if (!data || !Array.isArray(data)) {
        showMessage('Failed to load student data', 'error');
        return;
      }
      
      allStudents = data;
      
      // Calculate statistics
      const active = allStudents.filter(s => s.status === 'active').length;
      const inactive = allStudents.filter(s => s.status === 'inactive').length;
      const dropout = allStudents.filter(s => s.status === 'dropout').length;
      const total = allStudents.length;
      
      // Update counters
      document.getElementById('activeCount').textContent = active;
      document.getElementById('inactiveCount').textContent = inactive;
      document.getElementById('dropoutCount').textContent = dropout;
      document.getElementById('totalCount').textContent = total;
      
      // Update details
      document.getElementById('activeDetail').textContent = `${active} students`;
      document.getElementById('inactiveDetail').textContent = `${inactive} students`;
      document.getElementById('dropoutDetail').textContent = `${dropout} students`;
      document.getElementById('totalDetail').textContent = `${total} students`;
      
      // Update chart
      if (total > 0) {
        const activePct = Math.round((active / total) * 100);
        const inactivePct = Math.round((inactive / total) * 100);
        const dropoutPct = Math.round((dropout / total) * 100);
        
        document.getElementById('activePct').textContent = `${activePct}%`;
        document.getElementById('inactivePct').textContent = `${inactivePct}%`;
        document.getElementById('dropoutPct').textContent = `${dropoutPct}%`;
        
        document.getElementById('activeBar').style.width = `${activePct}%`;
        document.getElementById('activeBarLabel').textContent = `${activePct}%`;
        document.getElementById('inactiveBar').style.width = `${inactivePct}%`;
        document.getElementById('inactiveBarLabel').textContent = `${inactivePct}%`;
        document.getElementById('dropoutBar').style.width = `${dropoutPct}%`;
        document.getElementById('dropoutBarLabel').textContent = `${dropoutPct}%`;
      }
      
      showMessage('Statistics updated successfully!', 'success');
    }
    
    function refreshStats() {
      loadStudentStatistics();
    }
    
    // ===== USER MANAGEMENT =====
    async function loadUsers() {
      if (!currentUser || currentUser.role !== 'admin') return;
      
      const loadingEl = document.getElementById('usersLoading');
      const usersListEl = document.getElementById('usersList');
      loadingEl.style.display = 'block';
      usersListEl.innerHTML = '';
      
      const data = await apiRequest('getUsers');
      
      loadingEl.style.display = 'none';
      
      if (!data || !Array.isArray(data)) {
        showMessage('Failed to load users', 'error');
        return;
      }
      
      allUsers = data;
      renderUsersList();
    }
    
    function renderUsersList() {
      const usersList = document.getElementById('usersList');
      usersList.innerHTML = '';
      
      if (allUsers.length === 0) {
        usersList.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:20px;color:#6b7280">No users found</div>';
        return;
      }
      
      // Sort: admins first, then active users
      const sortedUsers = [...allUsers].sort((a, b) => {
        if (a.role === 'admin' && b.role !== 'admin') return -1;
        if (a.role !== 'admin' && b.role === 'admin') return 1;
        if (a.active === 'true' && b.active !== 'true') return -1;
        if (a.active !== 'true' && b.active === 'true') return 1;
        return a.username.localeCompare(b.username);
      });
      
      sortedUsers.forEach(user => {
        const isActive = user.active === 'true';
        const userCard = document.createElement('div');
        userCard.className = 'user-card';
        userCard.innerHTML = `
          <div style="font-weight:700;font-size:16px">${user.username}</div>
          <div class="user-role role-${user.role}">${user.role.charAt(0).toUpperCase() + user.role.slice(1)}</div>
          <div style="font-size:12px;color:#6b7280;margin-top:5px;display:flex;align-items:center">
            ${isActive ? '‚úÖ <span style="margin-left:5px">Active</span>' : '‚ùå <span style="margin-left:5px">Inactive</span>'}
          </div>
          <div class="user-actions">
            ${currentUser.username !== user.username ? 
              `<button class="user-btn ${isActive ? 'btn-delete' : 'btn-activate'}" 
                onclick="toggleUserStatus('${user.id}', ${!isActive})">
                ${isActive ? '‚ùå Deactivate' : '‚úÖ Activate'}
              </button>` : 
              '<button class="user-btn" disabled>Self</button>'
            }
          </div>
        `;
        usersList.appendChild(userCard);
      });
    }
    
    async function addNewUser() {
      const username = document.getElementById('newUsername').value.trim().toUpperCase();
      const password = document.getElementById('newPassword').value.trim();
      const role = document.getElementById('newUserRole').value;
      
 (!username || !password) {
        showMessage('Please fill in all fields', 'error');
        return;
      }
      
      if (password.length < 4) {
        showMessage('Password must be at least 4 characters', 'error');
        return;
      }
      
      // Check if username already exists (case-insensitive)
      if (allUsers.some(u => u.username.toUpperCase() === username)) {
        showMessage('Username already exists!', 'error');
        return;
      }
      
      // Show loading state
      const btn = event.target;
      const originalText = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<div class="loading" style="width:20px;height:20px;margin:0 auto"></div>';
      
      try {
        // In real implementation, this would call Google Sheets API
        // For demo, we'll simulate success and add to local list
        await new Promise(resolve => setTimeout(resolve, 800));
        
        // Add to local list (in real app, this would come from API response)
        const newUser = {
          id: (allUsers.length + 1).toString(),
          username: username,
          role: role,
          active: 'true'
        };
        
        allUsers.push(newUser);
        renderUsersList();
        
        // Clear form
        document.getElementById('newUsername').value = '';
        document.getElementById('newPassword').value = '';
        
        showMessage('User created successfully! (Password saved in Google Sheet)', 'success');
      } catch (error) {
        console.error('Add user error:', error);
        showMessage('Failed to create user: ' + error.message, 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    }
    
    async function toggleUserStatus(userId, activate) {
      if (!confirm(`Are you sure you want to ${activate ? 'activate' : 'deactivate'} this user?`)) return;
      
      try {
        const result = await apiRequest('updateUserStatus', 'post', {
          userId: userId,
          activate: activate
        });
        
        if (result && result.success) {
          // Update local data
          const user = allUsers.find(u => u.id === userId);
          if (user) user.active = activate ? 'true' : 'false';
          
          renderUsersList();
          showMessage(`User ${activate ? 'activated' : 'deactivated'} successfully!`, 'success');
        } else {
          throw new Error('Failed to update user status');
        }
      } catch (error) {
        console.error('Toggle user error:', error);
        showMessage('Failed to update user: ' + error.message, 'error');
      }
    }
    
    // ===== ATTENDANCE FUNCTIONS =====
    async function loadClassStudents() {
      const classId = document.getElementById('attClass').value;
      if (!Id) {
        document.getElementById('classStudentsList').style.display = 'none';
        document.getElementById('markAllBtn').style.display = 'none';
        return;
      }
      
      // Filter students by class and active status
      const classStudents = allStudents.filter(s => 
        s.class === classId && s.status === 'active'
      ).sort((a, b) => parseInt(a.id || 0) - parseInt(b.id || 0));
      
      if (classStudents.length ===0) {
        document.getElementById('classStudentsList').innerHTML = '<div style="padding:15px;text-align:center;color:#991b1b">No active students in this class</div>';
        document.getElementById('classStudentsList')..display = 'block';
        document.getElementById('markAllBtn').style.display = 'none';
        return;
      }
      
      // Render student list with status buttons
      let html = `<div style="margin-bottom:15px;font-weight:600;color:#1e293b">Mark attendance for ${classStudents.length} students:</div>`;
      
      classStudents.forEach(student => {
        html += `
          <div class="student-row" style="padding:12px;margin:8px 0">
            <div>
              <div class="student-info">${student.name || 'Unnamed Student'}</div>
              <div style="font-size:14px;color:#6b7280">Roll #${student.id || 'N/A'}</div>
            </div>
            <div style="display:flex;gap:8px">
              <button class="status-btn present small" data-id="${student.id}" data-status="present" style="padding:8px 12px;font-size:14px">‚úì</button>
              <button class="status-btn absent small" data-id="${student.id}" data-status="absent" style="padding:8px 12px;font-size:14px">‚úó</button>
            </div>
          </div>
        `;
      });
      
      document.getElementById('classStudentsList').innerHTML = html;
      document.getElementById('classStudentsList').style.display = 'block';
      document.getElementById('markAllBtn').style.display = 'block';
      
      // Add event listeners to status buttons
      document.querySelectorAll('#classStudentsList .status-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll(`#classStudentsList .status-btn[data-id="${this.dataset.id}"]`).forEach(b => b.classList.remove('active'));
          this.classList.add('active');
        });
      });
    }
    
    function markAllPresent() {
      document.querySelectorAll('#classStudentsList .status-btn.present').forEach(btn => {
        btn.classList.add('active');
        const sibling = btn.parentElement.querySelector('.status-btn.absent');
        if (sibling) sibling.classList.remove('active');
      });
      showMessage('All students marked present!', 'success');
    }
    
    async function saveAttendance() {
      const date = document.getElementById('attDate').value;
      const session = document.querySelector('.session-btn.active').dataset.session;
      const classId = document.getElementById('attClass').value;
      
      if (!date || !classId) {
        showMessage('Please select date and class', 'error');
        return;
      }
      
      // Get all marked students from the list
      const attendanceRecords = [];
      document.querySelectorAll('#classStudentsList .student-row').forEach(row => {
        const studentId = row.querySelector('.status-btn').dataset.id;
        const statusBtn = row.querySelector('.status-btn.active') || row.querySelector('.status-btn.present');
        const status = statusBtn.dataset.status;
        
        const student = allStudents.find(s => s.id === studentId);
        if (student) {
          attendanceRecords.push({
            date,
            class: classId,
            session,
            rollNumber: studentId,
            studentName: student.name || 'Unnamed Student',
            status,
            recordedBy: currentUser.username
          });
        }
      });
      
      if (attendanceRecords.length === 0) {
        showMessage('No attendance records to save', 'error');
        return;
      }
      
      // Show loading state
      const btn = event.target;
      const originalText = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<div class="loading" style="width:20px;height:20px;margin:0 auto"></div>';
      
      try {
        // Save first record as demo (real app would save all)
        await apiRequest('recordAttendance', 'post', {attendance: attendanceRecords[0]});
        
        showMessage(`‚úÖ Saved attendance for ${attendanceRecords.length} students!`, 'success');
        
        // Reset form
        document.getElementById('attRoll').value = '';
        document.getElementById('attName').value = '';
        document.querySelectorAll('.status-btn').forEach(b => b.classList.remove('active'));
        document.querySelector('.status-btn.present').classList.add('active');
      } catch (error) {
        console.error('Save attendance error:', error);
        showMessage('Failed to save attendance: ' + error.message, 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    }
    
    // ===== OTHER FUNCTIONS =====
    async function registerStudent() {
      const name = document.getElementById('regName').value.trim();
      const mother = document.getElementById('regMother').value.trim();
      const dob = document.getElementById('regDob').value;
      const pob = document.getElementById('regPob').value.trim();
      const phone = document.getElementById('regPhone').value.trim();
      const className = document.getElementById('regClass').value;
      const status = document.getElementById('regStatus').value;
      
      if (!name || !className) {
        showMessage('Name and Class are required', 'error');
        return;
      }
      
      const newStudent = {
        name, motherName: mother, dob, pob, phone, class: className, status
      };
      
      // Show loading state
      const btn = event.target;
      const originalText = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<div class="loading" style="width:20px;height:20px;margin:0 auto"></div>';
      
      try {
        const result = await apiRequest('addStudent', 'post', {student: newStudent});
        
        if (result && result.success) {
          // Update local data
          allStudents.push({
            id: result.id,
            ...newStudent,
            createdAt: new Date().toISOString()
          });
          
          // Refresh statistics
          await loadStudentStatistics();
          
          // Clear form
          document.getElementById('regName').value = '';
          document.getElementById('regMother').value = '';
          document.getElementById('regDob').value = '';
          document.getElementById('regPob').value = '';
          document.getElementById('regPhone').value = '';
          document.getElementById('regClass').value = '';
          document.getElementById('regStatus').value = '';
          
          showMessage('Student registered successfully!', 'success');
        } else {
          throw new Error('Failed to register student');
        }
      } catch (error) {
        console.error('Register student error:', error);
        showMessage('Failed to register student: ' + error.message, 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    }
    
    function processFee() {
      const student = document.getElementById('feeStudent').value.trim();
      const roll = document.getElementById('feeRoll').value.trim();
      const amount = document.getElementById('feeAmount').value.trim();
      
      if (!student || !roll || !amount) {
        showMessage('Please fill all fields', 'error');
        return;
      }
      
      showMessage('Fee payment processed successfully!', 'success');
    }
    
    function showMessage(text, type) {
      const msg = document.getElementById('globalMessage');
      msg.textContent = text;
      msg.className = `message ${type}`;
      msg.style.display = 'block';
      
      // Auto-hide after 3 seconds for success messages
      if (type === 'success') {
        setTimeout(() => {
          msg.style.display = 'none';
        }, 3000);
      }
    }
    
    function logout() {
      currentUser = null;
      document.getElementById('loginContainer').style.display = 'block';
      document.getElementById('appContainer').style.display = 'none';
      document.getElementById('loginForm').reset();
      document.getElementById('loginMessage').style.display = 'none';
      document.getElementById('globalMessage').style.display = 'none';
      
      // Reset tab content
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.getElementById('attendanceTab').classList.add('active');
    }
    
    // Initialize system
    document.addEventListener('DOMContentLoaded', () => {
      // Auto-focus username field
      document.getElementById('username').focus();
      
      // Add keyboard shortcut for login (Enter key)
      document.getElementById('loginForm').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          this.requestSubmit();
        }
      });
      
      // Auto-fill student name when roll number is entered
      document.getElementById('attRoll').addEventListener('change', function() {
        const roll = this.value;
        if (roll) {
          const student = allStudents.find(s => s.id === roll && s.status === 'active');
          if (student) {
            document.getElementById('attName').value = student.name || '';
            if (student.class) {
              document.getElementById('attClass').value = student.class;
              loadClassStudents();
            }
          } else {
            document.getElementById('attName').value = '';
            showMessage('Student not found or inactive', 'error');
          }
        }
      });
    });
  </script>
</body>
</html>
