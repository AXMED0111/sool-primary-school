<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sool School Management</title>
  <style>
    :root { --primary: #3b82f6; --success: #10b981; --danger: #ef4444; --warning: #f59e0b; --info: #0ea5e9; --purple: #8b5cf6; --bg: #f3f4f6; }
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family: -apple-system, sans-serif; background: linear-gradient(135deg,#1e3a8a 0%,#3b82f6 100%); min-height: 100vh; padding: 15px; }
    .container { max-width: 550px; margin: 0 auto; }
    .card { background: white; border-radius: 16px; padding: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); margin-bottom: 20px; }
    h1 { text-align: center; margin-bottom: 20px; color: #1e293b; }
    label { display: block; margin: 10px 0 5px; font-weight: 600; color: #4b5563; }
    input, select { width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 16px; margin-bottom: 10px; }
    .btn { width: 100%; padding: 14px; border: none; border-radius: 8px; font-size: 16px; font-weight: 700; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-success { background: var(--success); color: white; }
    .btn-danger { background: var(--danger); color: white; }
    .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); padding: 8px; font-size: 12px; }
    
    .tabs { display: flex; gap: 5px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; }
    .tab-btn { padding: 10px 15px; border: none; border-radius: 6px; background: #e5e7eb; cursor: pointer; font-weight: 600; white-space: nowrap; }
    .tab-btn.active { background: var(--primary); color: white; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .message { padding: 12px; border-radius: 8px; margin: 10px 0; text-align: center; display: none; font-weight: 600; }
    
    .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
    .stat-card { padding: 15px; border-radius: 12px; background: #f8fafc; border: 1px solid #e2e8f0; text-align: center; }
    .stat-val { font-size: 24px; font-weight: 800; color: var(--primary); }
    .stat-label { font-size: 11px; color: #64748b; text-transform: uppercase; }

    .table-container { overflow-x: auto; margin-top: 10px; border: 1px solid #e5e7eb; border-radius: 8px; max-height: 400px; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th { background: #f9fafb; padding: 10px; text-align: left; border-bottom: 2px solid #e5e7eb; position: sticky; top: 0; }
    td { padding: 10px; border-bottom: 1px solid #f3f4f6; }
    
    .clickable-name { color: var(--primary); font-weight: 600; cursor: pointer; text-decoration: underline; }
    
    .badge { padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; text-transform: uppercase; }
    .badge-absent { background: var(--danger); color: white; }
    .badge-sick { background: var(--purple); color: white; }
    .badge-late { background: var(--warning); color: white; }
    .badge-present { background: var(--success); color: white; }
    .badge-active { background: var(--success); color: white; }
    .badge-dropout { background: #64748b; color: white; }
    .badge-inactive { background: var(--warning); color: white; }

    .session-indicator { padding: 1px 4px; border-radius: 3px; font-weight: bold; font-size: 10px; margin-right: 2px; color: white; }
    .sess-m { background: #2563eb; } 
    .sess-b { background: #f97316; }

    .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; padding: 20px; }
    .modal-content { background: white; border-radius: 16px; width: 100%; max-width: 450px; max-height: 90vh; overflow-y: auto; padding: 25px; position: relative; }
    .close-modal { position: absolute; right: 20px; top: 20px; font-size: 24px; cursor: pointer; color: #64748b; }

    .quick-filters { display: flex; gap: 5px; overflow-x: auto; padding: 5px 0; margin-bottom: 10px; }
    .q-btn { padding: 6px 10px; border-radius: 20px; border: 1px solid #cbd5e1; background: white; font-size: 11px; white-space: nowrap; cursor: pointer; }
    .q-btn.active { background: #1e293b; color: white; border-color: #1e293b; }

    .att-btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px; }
    .att-btn { padding: 12px; border: 1px solid #e5e7eb; background: white; border-radius: 8px; cursor: pointer; font-weight: 600; text-align: center;}
    .att-btn.present.active { background: var(--success); color: white; }
    .att-btn.absent.active { background: var(--danger); color: white; }
    .att-btn.late.active { background: var(--warning); color: white; }
    .att-btn.sick.active { background: var(--purple); color: white; }
    
    .loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.7); z-index: 3000; align-items: center; justify-content: center;}
    body.loading .loading-overlay { display: flex; }
  </style>
</head>
<body>

  <div class="loading-overlay"><b>Processing...</b></div>

  <!-- Student Summary Modal -->
  <div id="studentModal" class="modal">
    <div class="modal-content">
      <span class="close-modal" onclick="closeModal()">&times;</span>
      <h2 id="modalName">Student Name</h2>
      <div id="modalMeta" style="margin-bottom: 15px;"></div>
      <hr>
      <div style="margin-top: 15px;">
        <h4 style="margin-bottom: 10px; color: #4b5563;">Attendance History (Absences/Sick)</h4>
        <div id="modalHistory" style="font-size: 13px;"></div>
      </div>
    </div>
  </div>

  <div class="container" id="loginView">
    <div class="card">
      <h1>üè´ Sool School</h1>
      <form id="loginForm">
        <label>Username</label>
        <input type="text" id="user" placeholder="Username" required>
        <label>Password</label>
        <input type="password" id="pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
        <button type="submit" class="btn btn-primary">Login</button>
      </form>
      <div id="loginMsg" class="message"></div>
    </div>
  </div>

  <div class="container" id="appView" style="display:none">
    <div class="card">
      <div style="text-align:center; margin-bottom:15px">
        <h2 id="greet">Dashboard</h2>
        <small id="roleDisplay" style="color:#666; text-transform:uppercase"></small>
      </div>

      <div class="tabs" id="nav">
        <button class="tab-btn active" onclick="showTab('att')">Attendance</button>
        <button class="tab-btn" onclick="showTab('list')">Records</button>
        <button class="tab-btn" onclick="showTab('stats')">Status</button>
      </div>

      <div id="appMsg" class="message"></div>

      <!-- Attendance Tab -->
      <div id="attTab" class="tab-content active">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px">
          <div><label>Date</label><input type="date" id="attDate"></div>
          <div><label>Session</label>
            <select id="attSession">
              <option value="Morning">Morning (M)</option>
              <option value="After Break">After Break (B)</option>
            </select>
          </div>
        </div>
        <label>Grade Level</label>
        <select id="attClass" onchange="handleClassChange('att')">
          <option value="">-- Select --</option>
          <option value="1aad">Grade 1</option><option value="2aad">Grade 2</option>
          <option value="3aad">Grade 3</option><option value="4aad">Grade 4</option>
          <option value="5aad">Grade 5</option><option value="6aad">Grade 6</option>
          <option value="7aad">Grade 7</option><option value="8aad">Grade 8</option>
        </select>
        
        <div id="previewList" style="display:none; background:#f9fafb; padding:10px; border-radius:8px; margin: 15px 0; max-height:150px; overflow-y:auto; border:1px solid #eee"></div>
        <button id="batchBtn" class="btn btn-success" style="display:none; margin-bottom:15px" onclick="markAll()">Mark Class Present</button>
        
        <hr>
        <label style="margin-top:15px">Roll #</label>
        <input type="number" id="rollId" placeholder="Enter Roll #" oninput="lookupStudent('att')">
        <input type="text" id="rollName" readonly style="background:#f3f4f6" placeholder="Name Result">
        
        <div class="att-btn-grid">
          <div class="att-btn present active" onclick="setAttStatus(this, 'present')">Present</div>
          <div class="att-btn absent" onclick="setAttStatus(this, 'absent')">Absent</div>
          <div class="att-btn late" onclick="setAttStatus(this, 'late')">Late</div>
          <div class="att-btn sick" onclick="setAttStatus(this, 'sick')">Sick</div>
        </div>
        <button class="btn btn-primary" onclick="saveOne()">Save Entry</button>
      </div>

      <!-- Records Tab -->
      <div id="listTab" class="tab-content">
        <div style="margin-bottom:15px">
          <label>View Mode</label>
          <select id="recordMode" onchange="resetFilters(); renderRecords()">
            <option value="students">Student List (Full)</option>
            <option value="absent" selected>Absent/Sick History</option>
            <option value="summary">Weekly/Monthly Summary</option>
          </select>
        </div>

        <div id="quickFilterContainer">
          <label style="font-size: 11px; margin-bottom: 2px;">Quick View (Yesterday):</label>
          <div class="quick-filters" id="gradeQuickFilters">
             <button class="q-btn" onclick="applyQuickFilter('1aad')">G1</button>
             <button class="q-btn" onclick="applyQuickFilter('2aad')">G2</button>
             <button class="q-btn" onclick="applyQuickFilter('3aad')">G3</button>
             <button class="q-btn" onclick="applyQuickFilter('4aad')">G4</button>
             <button class="q-btn" onclick="applyQuickFilter('5aad')">G5</button>
             <button class="q-btn" onclick="applyQuickFilter('6aad')">G6</button>
             <button class="q-btn" onclick="applyQuickFilter('7aad')">G7</button>
             <button class="q-btn" onclick="applyQuickFilter('8aad')">G8</button>
          </div>
        </div>

        <div id="filterSection" style="display:flex; flex-wrap:wrap; gap:10px; margin-bottom:10px">
            <select id="listFilter" onchange="renderRecords()" style="flex:1">
              <option value="all">All Grades</option>
              <option value="1aad">Grade 1</option><option value="2aad">Grade 2</option>
              <option value="3aad">Grade 3</option><option value="4aad">Grade 4</option>
              <option value="5aad">Grade 5</option><option value="6aad">Grade 6</option>
              <option value="7aad">Grade 7</option><option value="8aad">Grade 8</option>
            </select>
            <input type="date" id="dateFilter" onchange="renderRecords()" style="flex:1">
            <select id="sessionFilter" onchange="renderRecords()" style="flex:1">
              <option value="all">All Sessions</option>
              <option value="Morning">Morning</option>
              <option value="After Break">After Break</option>
            </select>
        </div>

        <button class="btn btn-outline" style="margin-bottom: 10px; width: auto; font-size: 11px;" onclick="exportCSV()">üì• Download CSV</button>

        <div class="table-container">
          <table id="recordTable">
            <thead id="recordHead"></thead>
            <tbody id="recordBody"></tbody>
          </table>
        </div>
      </div>

      <!-- Stats Tab -->
      <div id="statsTab" class="tab-content">
        <div class="stats-grid">
          <div class="stat-card"><div class="stat-val" id="statTotal">0</div><div class="stat-label">Total Students</div></div>
          <div class="stat-card"><div class="stat-val" id="statActive">0</div><div class="stat-label">Active</div></div>
          <div class="stat-card"><div class="stat-val" id="statDropout" style="color:var(--danger)">0</div><div class="stat-label">Dropouts</div></div>
          <div class="stat-card"><div class="stat-val" id="statInactive" style="color:var(--warning)">0</div><div class="stat-label">Inactive</div></div>
        </div>
        <button class="btn btn-primary" onclick="refreshData(true)">üîÑ Sync All Records</button>
      </div>

      <!-- Registration Tab (Admin Only) -->
      <div id="regTab" class="tab-content">
        <h3>Registration</h3>
        <label>Full Name</label><input type="text" id="rName">
        <label>Mother's Name</label><input type="text" id="rMother">
        <label>DOB</label><input type="date" id="rDob">
        <label>POB (Place of Birth)</label><input type="text" id="rPob">
        <label>Phone</label><input type="text" id="rPhone">
        <label>Grade</label>
        <select id="rClass">
          <option value="1aad">Grade 1</option><option value="2aad">Grade 2</option><option value="3aad">Grade 3</option><option value="4aad">Grade 4</option>
          <option value="5aad">Grade 5</option><option value="6aad">Grade 6</option>
          <option value="7aad">Grade 7</option><option value="8aad">Grade 8</option>
        </select>
        <label>Status</label>
        <select id="rStatus"><option value="active">Active</option><option value="dropout">Dropout</option><option value="inactive">Inactive</option></select>
        <button class="btn btn-primary" onclick="doRegister()">Complete Registration</button>
      </div>

      <!-- Fee Tab (Admin Only) -->
      <div id="feeTab" class="tab-content">
        <h3>Fees</h3>
        <label>Grade</label>
        <select id="fClass" onchange="lookupStudent('fee')">
          <option value="">-- Select --</option>
          <option value="1aad">Grade 1</option><option value="2aad">Grade 2</option>
          <option value="3aad">Grade 3</option><option value="4aad">Grade 4</option>
          <option value="5aad">Grade 5</option><option value="6aad">Grade 6</option>
          <option value="7aad">Grade 7</option><option value="8aad">Grade 8</option>
        </select>
        <label>Roll #</label><input type="number" id="fRoll" oninput="lookupStudent('fee')">
        <input type="text" id="fName" readonly style="background:#eee" placeholder="Student Name">
        <label>Amount ($)</label><input type="number" id="fAmt">
        <label>Term</label>
        <select id="fSession"><option value="Term 1">Term 1</option><option value="Term 2">Term 2</option></select>
        <button class="btn btn-success" onclick="doFee()">Save Payment</button>
      </div>

      <button class="btn btn-danger" style="margin-top:20px; font-size:12px; border:1px solid #fee2e2; background:none; color:var(--danger)" onclick="location.reload()">Logout</button>
    </div>
  </div>

  <script>
    const API = 'https://script.google.com/macros/s/AKfycbw-dTnjjKs-evVDQ-dOxuGTnlxxSLazJSvJn3JHxOBJuzqbxT4EzApDLXarBRheDUuBvA/exec';
    let user = null, students = [], attLogs = [], attSummary = {}, currentAttStatus = 'present';
    let studentCache = {};

    function msg(text, type='success') {
      const el = user ? document.getElementById('appMsg') : document.getElementById('loginMsg');
      el.textContent = text; el.className = `message ${type}`; el.style.display = 'block';
      setTimeout(() => el.style.display = 'none', 4000);
    }

    async function call(action, data={}, quiet=false) {
      if(!quiet) document.body.classList.add('loading');
      try {
        const r = await fetch(API, { method: 'POST', body: JSON.stringify({...data, action}) });
        const res = await r.json();
        if(!quiet) document.body.classList.remove('loading');
        return res;
      } catch(e) {
        if(!quiet) document.body.classList.remove('loading');
        msg("Sync Error", "error"); return { error: true };
      }
    }

    document.getElementById('loginForm').onsubmit = async (e) => {
      e.preventDefault();
      const res = await call('login', { username: document.getElementById('user').value, password: document.getElementById('pass').value });
      if(res.success) {
        user = res.user;
        document.getElementById('loginView').style.display = 'none';
        document.getElementById('appView').style.display = 'block';
        document.getElementById('greet').textContent = `Hi, ${user.username}`;
        document.getElementById('roleDisplay').textContent = user.role;
        document.getElementById('attDate').valueAsDate = new Date();
        if(user.role === 'admin') {
          document.getElementById('nav').innerHTML += `<button class="tab-btn" onclick="showTab('reg')">Reg</button>`;
          document.getElementById('nav').innerHTML += `<button class="tab-btn" onclick="showTab('fee')">Fees</button>`;
        }
        showTab('att');
        refreshData();
      } else msg(res.message || "Login Failed", "error");
    };

    async function refreshData(manual=false) {
      const [sData, lData, sumData] = await Promise.all([
        call('getStudents', {}, !manual),
        call('getAttendanceLogs', {}, !manual),
        call('getAttendanceSummary', {}, true)
      ]);
      if(Array.isArray(sData)) {
          students = sData;
          studentCache = {};
          students.forEach(s => studentCache[`${s.Class}_${s.ID}`] = s.Name);
      }
      if(Array.isArray(lData)) attLogs = lData;
      if(sumData && !sumData.error) attSummary = sumData;
      updateStats();
      renderRecords();
      if(manual) msg("Refreshed");
    }

    function updateStats() {
      document.getElementById('statTotal').textContent = students.length;
      document.getElementById('statActive').textContent = students.filter(s => String(s.Status).toLowerCase() === 'active').length;
      document.getElementById('statDropout').textContent = students.filter(s => String(s.Status).toLowerCase() === 'dropout').length;
      document.getElementById('statInactive').textContent = students.filter(s => String(s.Status).toLowerCase() === 'inactive').length;
    }

    function resetFilters() {
      document.getElementById('listFilter').value = 'all';
      document.getElementById('dateFilter').value = '';
      document.getElementById('sessionFilter').value = 'all';
      document.querySelectorAll('.q-btn').forEach(b => b.classList.remove('active'));
    }

    function applyQuickFilter(grade) {
      document.getElementById('recordMode').value = 'absent';
      document.getElementById('listFilter').value = grade;
      const yest = new Date();
      yest.setDate(yest.getDate() - 1);
      document.getElementById('dateFilter').value = yest.toISOString().split('T')[0];
      document.querySelectorAll('.q-btn').forEach(b => {
        b.classList.toggle('active', b.textContent.includes(grade.replace('aad','')));
      });
      renderRecords();
    }

    // Modal Controller
    window.openStudentSummary = (roll, grade) => {
      const student = students.find(s => String(s.ID) === String(roll) && s.Class === grade);
      if(!student) return;

      const modal = document.getElementById('studentModal');
      const nameEl = document.getElementById('modalName');
      const metaEl = document.getElementById('modalMeta');
      const historyEl = document.getElementById('modalHistory');

      nameEl.textContent = student.Name;
      const statusClass = `badge-${String(student.Status).toLowerCase()}`;
      metaEl.innerHTML = `
        <div style="display:flex; justify-content:space-between; margin-bottom:5px">
          <span>Roll: <b>#${student.ID}</b> | Grade: <b>${student.Class}</b></span>
          <span class="badge ${statusClass}">${student.Status}</span>
        </div>
      `;

      // Filter logs (Sick or Absent only)
      const logs = attLogs.filter(l => String(l.roll) === String(roll) && l.class === grade && (l.status === 'absent' || l.status === 'sick'));
      const absCount = logs.filter(l => l.status === 'absent').length;
      const sickCount = logs.filter(l => l.status === 'sick').length;

      let historyHtml = `
        <div style="background:#f1f5f9; padding:10px; border-radius:8px; margin-bottom:10px; display:flex; gap:10px; text-align:center">
          <div style="flex:1">Absent<br><b>${absCount}</b></div>
          <div style="flex:1">Sick<br><b>${sickCount}</b></div>
        </div>
      `;

      if(logs.length === 0) {
        historyHtml += `<p style="color:#94a3b8; text-align:center; padding:10px">No absence/sick records found.</p>`;
      } else {
        logs.sort((a,b) => new Date(b.date) - new Date(a.date));
        historyHtml += `<ul style="list-style:none; max-height:250px; overflow-y:auto">`;
        logs.forEach(l => {
          const d = new Date(l.date);
          const dateStr = `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth()+1).padStart(2, '0')}/${d.getFullYear()}`;
          historyHtml += `
            <li style="padding:8px; border-bottom:1px solid #f1f5f9; display:flex; justify-content:space-between; align-items:center">
              <span>${dateStr} <small style="color:#64748b">(${l.session})</small></span>
              <span class="badge badge-${l.status}">${l.status}</span>
            </li>`;
        });
        historyHtml += `</ul>`;
      }

      historyEl.innerHTML = historyHtml;
      modal.style.display = 'flex';
    };

    window.closeModal = () => document.getElementById('studentModal').style.display = 'none';

    function renderRecords() {
      const mode = document.getElementById('recordMode').value;
      const grade = document.getElementById('listFilter').value;
      const dateVal = document.getElementById('dateFilter').value;
      const sessionVal = document.getElementById('sessionFilter').value;
      const head = document.getElementById('recordHead');
      const body = document.getElementById('recordBody');
      const dateInp = document.getElementById('dateFilter');
      const sessInp = document.getElementById('sessionFilter');
      const quickBox = document.getElementById('quickFilterContainer');
      
      body.innerHTML = '';
      const isHistory = (mode === 'absent');
      dateInp.style.display = isHistory ? 'block' : 'none';
      sessInp.style.display = isHistory ? 'block' : 'none';
      quickBox.style.display = isHistory ? 'block' : 'none';

      if (mode === 'students') {
        head.innerHTML = '<tr><th>Roll</th><th>Name</th><th>Status</th></tr>';
        students.filter(s => grade === 'all' || s.Class === grade).forEach(s => {
          body.innerHTML += `
            <tr>
              <td>${s.ID}</td>
              <td><span class="clickable-name" onclick="openStudentSummary('${s.ID}', '${s.Class}')">${s.Name}</span></td>
              <td><span class="badge badge-${String(s.Status).toLowerCase()}">${s.Status}</span></td>
            </tr>`;
        });
      } 
      else if (mode === 'absent') {
        head.innerHTML = '<tr><th>Date</th><th>Name</th><th>Log</th></tr>';
        const grouped = {};
        attLogs.filter(l => {
          const isAbs = l.status === 'absent' || l.status === 'sick';
          const isGrade = grade === 'all' || l.class === grade;
          
          const logDateStr = new Date(l.date).toISOString().split('T')[0];
          const isDate = !dateVal || logDateStr === dateVal;
          const isSession = sessionVal === 'all' || l.session === sessionVal;
          return isAbs && isGrade && isDate && isSession;
        }).forEach(l => {
           const d = new Date(l.date);
           const displayDate = `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth()+1).padStart(2, '0')}/${d.getFullYear()}`;
           const key = `${l.roll}_${l.class}_${displayDate}`;
           
           if(!grouped[key]) grouped[key] = { date: displayDate, name: l.name, roll: l.roll, class: l.class, sessions: [], statuses: new Set() };
           const code = (l.session === 'Morning') ? 'M' : (l.session === 'After Break' ? 'B' : '?');
           if(!grouped[key].sessions.includes(code)) grouped[key].sessions.push(code);
           grouped[key].statuses.add(l.status);
        });

        Object.values(grouped).forEach(g => {
           const sessHtml = g.sessions.sort().map(s => `<span class="session-indicator sess-${s.toLowerCase()}">${s}</span>`).join('');
           const statusText = Array.from(g.statuses).join(' / ');
           body.innerHTML += `
            <tr>
              <td>${g.date}</td>
              <td><span class="clickable-name" onclick="openStudentSummary('${g.roll}', '${g.class}')">${g.name}</span></td>
              <td><small>${g.class}<br>${sessHtml} <span class="badge badge-${Array.from(g.statuses)[0]}">${statusText}</span></small></td>
            </tr>`;
        });
      }
      else if (mode === 'summary') {
        head.innerHTML = '<tr><th>Roll</th><th>Name</th><th>Wk</th><th>Mo</th></tr>';
        students.filter(s => (grade === 'all' || s.Class === grade) && String(s.Status).toLowerCase() === 'active').forEach(s => {
          const stats = attSummary[String(s.ID)] || { w: 0, m: 0 };
          body.innerHTML += `
            <tr>
              <td>${s.ID}</td>
              <td><span class="clickable-name" onclick="openStudentSummary('${s.ID}', '${s.Class}')">${s.Name}</span></td>
              <td>${stats.w}d</td>
              <td>${stats.m}d</td>
            </tr>`;
        });
      }
    }

    function exportCSV() {
      const mode = document.getElementById('recordMode').value;
      let rows = [];
      const table = document.getElementById('recordTable');
      const header = Array.from(table.querySelectorAll('th')).map(th => th.innerText);
      rows.push(header.join(','));
      Array.from(table.querySelectorAll('tbody tr')).forEach(tr => {
        const data = Array.from(tr.querySelectorAll('td')).map(td => `"${td.innerText.replace(/\n/g, ' ')}"` );
        rows.push(data.join(','));
      });
      const csvContent = "data:text/csv;charset=utf-8," + rows.join("\n");
      const link = document.createElement("a");
      link.setAttribute("href", encodeURI(csvContent));
      link.setAttribute("download", `SoolSchool_${mode}.csv`);
      link.click();
    }

    window.showTab = (t) => {
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.getElementById(t+'Tab').classList.add('active');
      const btn = Array.from(document.querySelectorAll('.tab-btn')).find(b => b.getAttribute('onclick')?.includes(`'${t}'`));
      if(btn) btn.classList.add('active');
      if(t === 'list') renderRecords();
    };

    window.handleClassChange = (type) => {
      const cls = document.getElementById('attClass').value;
      document.getElementById('batchBtn').style.display = cls ? 'block' : 'none';
      lookupStudent(type);
      if(type === 'att') {
         const box = document.getElementById('previewList');
         if(!cls) { box.style.display = 'none'; } 
         else {
           const list = students.filter(s => String(s.Class) === String(cls) && String(s.Status).toLowerCase() === 'active');
           box.innerHTML = list.map(s => `<div style="padding:3px 0; font-size:11px">#${s.ID} ${s.Name}</div>`).join('') || "No active students";
           box.style.display = 'block';
         }
      }
    };

    window.lookupStudent = (type) => {
      const isAtt = (type === 'att');
      const roll = document.getElementById(isAtt ? 'rollId' : 'fRoll').value;
      const cls = document.getElementById(isAtt ? 'attClass' : 'fClass').value;
      const display = document.getElementById(isAtt ? 'rollName' : 'fName');
      if(!roll || !cls) { display.value = ""; return; }
      const name = studentCache[`${cls}_${roll}`];
      if(name) { display.value = name; } else { display.value = ""; display.placeholder = "Not found"; }
    };

    window.setAttStatus = (btn, s) => {
      btn.parentElement.querySelectorAll('.att-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active'); currentAttStatus = s;
    };

    window.saveOne = async () => {
      const roll = document.getElementById('rollId').value, name = document.getElementById('rollName').value, cls = document.getElementById('attClass').value;
      if(!roll || !cls || !name) return msg("Verify Roll/Class", "error");
      const res = await call('recordAttendance', {
        date: document.getElementById('attDate').value, session: document.getElementById('attSession').value,
        class: cls, rollNumber: roll, studentName: name, status: currentAttStatus, recordedBy: user.username
      });
      if(res.success) { msg("Saved"); document.getElementById('rollId').value = ""; document.getElementById('rollName').value = ""; refreshData(); }
    };

    window.markAll = async () => {
      const res = await call('markAllPresent', {
        date: document.getElementById('attDate').value, session: document.getElementById('attSession').value,
        class: document.getElementById('attClass').value, recordedBy: user.username
      });
      if(res.success) { msg("Class Present"); refreshData(); }
    };

    window.doRegister = async () => {
      const name = document.getElementById('rName').value;
      if(!name) return msg("Name required", "error");
      const res = await call('addStudent', {
        name, motherName: document.getElementById('rMother').value, dob: document.getElementById('rDob').value,
        pob: document.getElementById('rPob').value, phone: document.getElementById('rPhone').value,
        class: document.getElementById('rClass').value, status: document.getElementById('rStatus').value
      });
      if(res.success) { msg("Registered: ID "+res.id); document.getElementById('rName').value = ""; refreshData(true); }
    };

    window.doFee = async () => {
      const roll = document.getElementById('fRoll').value, amt = document.getElementById('fAmt').value, name = document.getElementById('fName').value, cls = document.getElementById('fClass').value;
      if(!roll || !amt || !cls || !name) return msg("Check fields", "error");
      const res = await call('processFee', { student: name, roll, amount: amt, session: document.getElementById('fSession').value, recordedBy: user.username, class: cls });
      if(res.success) { msg("Payment Saved"); document.getElementById('fRoll').value = ""; document.getElementById('fAmt').value = ""; }
    };

    window.onclick = (e) => { if(e.target == document.getElementById('studentModal')) closeModal(); };
  </script>
</body>
</html>
